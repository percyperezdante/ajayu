# A brief introduction

This is a template to build an Oracle Linux 6 (OL6) image with a standalone Jenkins and capistrano 2.5 using Packer.  Note that this template is base on the ```oracle_linux_6``` template that you can find in this repository. 

# Pre-requirements.

It would be good if you have already installed the following:

- Go
  Steps to install from source code in [here](https://golang.org/doc/install/source)

- Packer
  Manual installation from source code in [here](https://github.com/hashicorp/packer/blob/master/.github/CONTRIBUTING.md#setting-up-go-to-work-on-packer)


For testing purposes you may need Vagrant and VirtualBox installed.

# How to build OL6 image

```bash
$ git clone https://github.com/percyperezdante/ajayu.git
$ cd ajayu/jenkinsCapistranoOl6
$ packer build jenkinsCapistranoOl6.json 
### OR
$ ./start.sh
```

The last command may take a while during the first run, but the subsequent runs will be faster as all is cached locally at "packer_cache". 

The result of this command will be the file "oracle-linux-6-x86_64_packer-6.10-SNAPSHOT.box" which is the OL6 image with Jenkins and Capistran 2

# How to clear packer files

To clear all file systems generated by packer, run as:

```bash
$ rm -rf packer_cache    # <-- This clears cache which includes the *.iso image
$ rm -rf *-SNAPSHOT.box
```

After this you can run build again the image by

```bash
$./start.sh
```


# How to install custom packages

To install additional features, you can follow the next steps:

1. Add the name of the new script in the template,jenkinsCapistranoOl6.json. For example if we want to add scripts/additional/install_nginx.sh
```bash
        ...
        {
            "type": "shell",
            "script": "scripts/additional/install_capistrano2.sh"
        },
        {
            "type": "shell",
            "script": "scripts/additional/install_nginx.sh"
        }

```

2. Place the install_nginx.sh inside the script/additional folder

3. Back to the root directory, remove move any .box file already created and build the image again.

```bash
$ rm *.box
$./start.sh

```

# How to start to use Jenkins with Capistrano 2.

There are many option to use the already built images, but in here we just suggest one through an example. In this example we add the image to a Vagrant list, and the we start up one VM with this image using vagrant. To verify, you can login to the box and execute an internal inspection if needed.

1. Create the vagrant init

```bash
$ vagrant box add --name myJenkinsCapv2 oracle-linux-6-x86_64_packer-6.10-SNAPSHOT.box
$ vagrant box list
$ mkdir test
$ cd test
$ vagrant init myJenkinsCapv2 
```
2. Add forward port 8080 in your Vagrant init config file.
Your ./Vagrant file should looks like:

```bash
Vagrant.configure("2") do |config|
  config.vm.box = "myJenkinsCapv2"
  config.vm.box_url = "."
  config.vm.network "forwarded_port", guest: 8080, host: 8080
end
```
3. Start your VM
```bash
$ vagrant up
$ vagrant ssh
```

4. Open your ```http://localhost:8080``` in your browser.

You should be able to see the Login page for Jenkins. The following users are available.

```bash
percy
tester
```

The default password for these accounts is 123.


# Ajayu from the cloud

You can download this image from Vagrant cloud as following:

1. Create a local folder

```bash
$ mkdir ajayu
$ cd ajayu
```

2. Create a Vagrantfile with the following content

```bash
Vagrant.configure("2") do |config|
  config.vm.box = "percyperezd/JenkinsCapistranoV2"
  config.vm.box_version = "0.0.1"
  config.vm.network "forwarded_port", guest: 8080, host: 8080
end
```

3. Start vagrant

```bash
$ vagrant status
$ vagrant up
```

4. Open ```http://localhost:8080``` from a browser.

# Test artefacts of the image with Kitchen.
Todo


# References

Here some of most relevant link used to compose this template.

- [How to install Jenkis](https://www.openprogrammer.info/2015/07/25/how-to-install-jenkins-continuous-integration-on-centos-6-as-service/)
- [How to install Ruby and capistrano](https://gist.github.com/Halleck45/9645694)
- [Jenkins package repository](https://pkg.jenkins.io/redhat-stable/)
- [Capistrano - ruby download](https://rubygems.org/gems/capistrano/versions/2.15.9)

