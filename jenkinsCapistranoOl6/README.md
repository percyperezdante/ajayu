# Jenkins and Capistrano v2 base on OL6

This is a template to build an Oracle Linux 6 (OL6) image with a standalone Jenkins and capistrano 2.5 using Packer.  Note that this template is base on the ```oracle_linux_6``` template that you can find in this repository. 

# Pre-requirements.

It would be good if you have already installed the following:

- Go
  Steps to install from source code in [here](https://golang.org/doc/install/source)

- Packer
  Manual installation from source code in [here](https://github.com/hashicorp/packer/blob/master/.github/CONTRIBUTING.md#setting-up-go-to-work-on-packer)


For testing purposes you may need Vagrant and VirtualBox installed.

# How to build OL6 image

```bash
$ git clone https://github.com/percyperezdante/ajayu.git
$ cd ajayu/jenkinsCapistranoOl6
$ packer build jenkinsCapistranoOl6.json 
### OR
$ ./start.sh
```

The last command may take a while during the first run, but the subsequent runs will be faster as all is cached locally at "packer_cache". 

The result of this command will be the file "oracle-linux-6-x86_64_packer-6.10-SNAPSHOT.box" which is the OL6 image with Jenkins and Capistran 2

# How to clear packer files

To clear all file systems generated by packer, run as:

```bash
$ rm -rf packer_cache    # <-- This clears cache which includes the *.iso image
$ rm -rf *-SNAPSHOT.box
```

After this you can run build again the image by

```bash
$./start.sh
```


# How to install custom packages

To install additional features, you can follow the next steps:

1. Add the name of the new script in the template,jenkinsCapistranoOl6.json. For example if we want to add scripts/additional/install_nginx.sh
```bash
        ...
        {
            "type": "shell",
            "script": "scripts/additional/install_capistrano2.sh"
        },
        {
            "type": "shell",
            "script": "scripts/additional/install_nginx.sh"
        }

```

2. Place the install_nginx.sh inside the script/additional folder

3. Back to the root directory, remove move any .box file already created and build the image again.

```bash
$ rm *.box
$./start.sh

```

# How to start to use Jenkins with Capistrano 2.

There are many option to use the already built images, but in here we just suggest one through an example. In this example we add the image to a Vagrant list, and the we start up one VM with this image using vagrant. To verify, you can login to the box and execute an internal inspection if needed.

1. Create the vagrant init

```bash
$ vagrant box add --name myJenkinsCapv2 oracle-linux-6-x86_64_packer-6.10-SNAPSHOT.box
$ vagrant box list
$ mkdir test
$ cd test
$ vagrant init myJenkinsCapv2 
```
2. Add forward port 8080 in your Vagrant init config file.
Your ./Vagrant file should looks like:

```bash
Vagrant.configure("2") do |config|
  config.vm.box = "myJenkinsCapv2"
  config.vm.box_url = "."
  config.vm.network "forwarded_port", guest: 8080, host: 8080
end
```
3. Start your VM
```bash
$ vagrant up
$ vagrant ssh
```

4. Open your ```http://localhost:8080``` in your browser.

You should be able to see the Login page for Jenkins. The following users are available.

```bash
percy
tester
```

The default password for these accounts is 123.


# Ajayu from the cloud

You can [download this image from Vagrant cloud](https://app.vagrantup.com/percyperezd/boxes/JenkinsCapistranoV2) as following:


1. Create a local folder

```bash
$ mkdir ajayu
$ cd ajayu
```

2. Create a Vagrantfile with the following content

```bash
Vagrant.configure("2") do |config|
  config.vm.box = "percyperezd/JenkinsCapistranoV2"
  config.vm.box_version = "0.0.2"
  config.vm.network "forwarded_port", guest: 8080, host: 8080
end
```

3. Start vagrant

```bash
$ vagrant status
$ vagrant up
```

4. Open ```http://localhost:8080``` from a browser.

# Basic example capistrano

1. Deploy a Jenkins node and a deployment host.

```bash
$ mkdir myfirstime
$ cd myfirsttime
$ git clone https://github.com/percyperezdante/ajayu.git
$ cd ajayu/jenkinsCapistranoOl6/examples/basic
$ cat Vagrantfile
$ vagrant up
```

NOTE:

This will deploy a Jenkins master and a deployment host (called victim in this example). The deployment host is the host where you can deploy your artifacts using capistrano. 

2. Create a free style job

Open a `http://localhost:8080` in your browser and create a free style job.

NOTE:

You also can use an already created job in the dashboard, called `cap_rollback_on_transactions` in the "Examples for reference" folder.

3. In the build section add a "Execute shell" and copy the following

```bash
echo '''
server "127.0.0.1", :all, {:group => 1}
''' > servers.cap
```

4. Add another "Execute shell" and copy the following
```bash
echo '''

roles[:all]
roles[:app]

load :file => "servers.cap"

namespace :deploy do
    task :default do
          transaction do
                on_rollback do
                  puts "====== ROLLBACK \n\n"
                end
				list_packages
    			check_prereqs
    			app_deploy

			end
    end

    task :list_packages do
      puts "LIST PACKAGES \n\n"

	end

    task :check_prereqs  do
      puts "CHECK PREREQS \n\n"
      run "echo 123 > test"     # <--- You can make fail this to trigger the rollback

    end

    task :app_deploy  do
      puts "APP DEPLOY \n\n"
    end

    task :rollback_now  do
      puts "ROLLBACK NOW \n\n"
    end

end

''' > deploy.cap

```

5.  Execute the capistrano code by addint the following "Execute shell"

```bash
cap -f deploy.cap deploy
```

NOTE:
```bash
cap -d -f deploy.cap deploy
```

You can run debug mode as:


6.  Save and build the job. You should be get the following console output or similar

```bash

Started by user unknown or anonymous
Running as SYSTEM
Building in workspace /app/jenkins/jobs/examples/jobs/cap_rollback_on_transactions/workspace
[workspace] $ /bin/sh -xe /tmp/jenkins171893622896159376.sh
+ set +x
[workspace] $ /bin/sh -xe /tmp/jenkins8265841782960213732.sh
+ set +x
[workspace] $ /bin/sh -xe /tmp/jenkins6283116836644112696.sh
+ cap -f deploy.cap deploy
  * executing `deploy'
 ** transaction: start
  * executing `deploy:list_packages'
LIST PACKAGES 

  * executing `deploy:check_prereqs'
CHECK PREREQS 

  * executing "echo test > test"
    servers: ["127.0.0.1"]
    [127.0.0.1] executing command
    command finished in 278ms
  * executing `deploy:app_deploy'
APP DEPLOY 

 ** transaction: commit
Finished: SUCCESS

```

NOTE:
Capistrano reads from .ssh/config to identify remote host to deploy artifacts. 
Double check that your config file contains the following parameters:

```bash
Host 127.0.0.1
  Hostname localhost
  User deploy
```


# Test artefacts of the image with Kitchen.
Todo


# References

Here some of most relevant link used to compose this template.

- [How to install Jenkis](https://www.openprogrammer.info/2015/07/25/how-to-install-jenkins-continuous-integration-on-centos-6-as-service/)
- [How to install Ruby and capistrano](https://gist.github.com/Halleck45/9645694)
- [Jenkins package repository](https://pkg.jenkins.io/redhat-stable/)
- [Capistrano - ruby download](https://rubygems.org/gems/capistrano/versions/2.15.9)
- [Capistrano 2 docs](https://github.com/capistrano/capistrano-2.x-docs/)
- [Capistrano authentication](https://capistranorb.com/documentation/getting-started/authentication-and-authorisation/)
